<?php 
$competencias = array(
    'c_iniciativa'          => array(
                                        'name' => 'Iniciativa y compromiso',
                                        'description' => 'Autonomía, constancia y tenacidad. Emprendimiento, automotivación y orientación al logro',
                                        'icon' => 'iniciativa',
                                        'position' => array('x' => '0', 'y' => '0')
                                    ),
    'c_resolucion'          => array(
                                        'name' => 'Resolución de problemas',
                                        'description' => 'Análisis de problemas, toma de decisiones, pensamiento analítico',
                                        'icon' => 'resolucion',
                                        'position' => array('x' => '0', 'y' => '1')
                                    ),
    'c_creatividad'         => array(
                                        'name' => 'Creatividad e innovación',
                                        'description' => 'Creatividad, innovación, originalidad',
                                        'icon' => 'creatividad',
                                        'position' => array('x' => '0', 'y' => '2')
                                    ),
    'c_planificacion'       => array(
                                        'name' => 'Planificación y estrategia',
                                        'description' => 'Organización, orientación estratégica, orientación a resultados, priorización',
                                        'icon' => 'planificacion',
                                        'position' => array('x' => '0', 'y' => '3')
                                    ),
    'c_aprendizaje'         => array(
                                        'name' => 'Facilidad de aprendizaje',
                                        'description' => 'Curiosidad, motivación autónoma, interés y rapidez para asimilar información nueva ',
                                        'icon' => 'aprendizaje',
                                        'position' => array('x' => '0', 'y' => '4')
                                    ),
    'c_comunicacion'        => array(
                                        'name' => 'Comunicación',
                                        'description' => 'Capacidad de comunicación oral y escrita',
                                        'icon' => 'comunicacion',
                                        'position' => array('x' => '1', 'y' => '0')
                                    ),
    'c_negociacion'         => array(
                                        'name' => 'Negociación',
                                        'description' => 'Capacidad comercial, persuasión, asertividad',
                                        'icon' => 'negociacion',
                                        'position' => array('x' => '1', 'y' => '1')
                                    ),
    'c_cliente'             => array(
                                        'name' => 'Orientación al cliente',
                                        'description' => 'Atención al cliente, capacidad de proveer explicaciones más y menos técnicas',
                                        'icon' => 'cliente',
                                        'position' => array('x' => '1', 'y' => '2')
                                    ),
    'c_critica'             => array(
                                        'name' => 'Pensamiento crítico',
                                        'description' => 'Capacidad de argumentar, de sintetizar, de analizar lenguaje explícito e implícito',
                                        'icon' => 'critica',
                                        'position' => array('x' => '1', 'y' => '3')
                                    ),
    'c_analisis'            => array(
                                        'name' => 'Análisis numérico',
                                        'description' => 'Razonamiento numérico, comprensión y manejo de conceptos matemático',
                                        'icon' => 'analisis',
                                        'position' => array('x' => '1', 'y' => '4')
                                    ),
    'c_calidad'             => array(
                                        'name' => 'Orientación a la calidad',
                                        'description' => 'Meticulosidad, exactitud, precisión, fiabilidad',
                                        'icon' => 'calidad',
                                        'position' => array('x' => '2', 'y' => '0')
                                    ),
    'c_espacialidad'        => array(
                                        'name' => 'Pensamiento espacial',
                                        'description' => 'Comprensión de interpretación y visualización de espacios y lugares, capacidad de orientación',
                                        'icon' => 'espacialidad',
                                        'position' => array('x' => '2', 'y' => '1')
                                    ),
    'c_coordinacion'        => array(
                                        'name' => 'Coordinación motora',
                                        'description' => 'Habilidad de movimiento y precisión corporal y manual',
                                        'icon' => 'coordinacion',
                                        'position' => array('x' => '2', 'y' => '2')
                                    ),
    'c_descubrimiento'      => array(
                                        'name' => 'Interés por el descubrimiento',
                                        'description' => 'Capacidad de investigación, pensamiento científico',
                                        'icon' => 'descubrimiento',
                                        'position' => array('x' => '2', 'y' => '3')
                                    ),
    'c_empatia'             => array(
                                        'name' => 'Empatía',
                                        'description' => 'Capacidad de tener una perspectiva distinta, de ponerse en el lugar del otro, de escucha activa',
                                        'icon' => 'empatia',
                                        'position' => array('x' => '2', 'y' => '4')
                                    ),
    'c_equipo'              => array(
                                        'name' => 'Trabajo en equipo',
                                        'description' => 'Capacidad de coordinarse con otras personas, delegar, admitir los conocimientos de los miembros del equipo',
                                        'icon' => 'equipo',
                                        'position' => array('x' => '2', 'y' => '5')
                                    ),
    'c_social'              => array(
                                        'name' => 'Habilidades sociales',
                                        'description' => 'Don de gentes, sociabilidad, networking, conocimientos interpersonales, inteligencia social',
                                        'icon' => 'social',
                                        'position' => array('x' => '3', 'y' => '0')
                                    ),
    'c_adaptabilidad'       => array(
                                        'name' => 'Adaptabilidad',
                                        'description' => 'Orientación al cambio, flexibilidad, inteligencia emocional, autorregulación',
                                        'icon' => 'adaptabilidad',
                                        'position' => array('x' => '3', 'y' => '1')
                                    ),
    'c_liderazgo'           => array(
                                        'name' => 'Liderazgo',
                                        'description' => 'Capacidad de mando y decisión, visión estratégica',
                                        'icon' => 'liderazgo',
                                        'position' => array('x' => '3', 'y' => '2')
                                    ),
    'c_integridad'          => array(
                                        'name' => 'Integridad',
                                        'description' => 'Ética, conciencia y compromiso ético',
                                        'icon' => 'integridad',
                                        'position' => array('x' => '3', 'y' => '3')
                                    ),
    'c_transmision'         => array(
                                        'name' => 'Transmisión de conocimientos',
                                        'description' => 'Capacidad e interés en formar a otros y divulgar información ',
                                        'icon' => 'transmision',
                                        'position' => array('x' => '3', 'y' => '4')
                                    ),
    'c_tecnologia'          => array(
                                        'name' => 'Habilidad Tecnológica',
                                        'description' => 'Adaptabilidad a las tecnologías, habilidades informáticas y electrónicas',
                                        'icon' => 'tecnologia',
                                        'position' => array('x' => '3', 'y' => '5')
                                    ),
    'c_sensibilidad'        => array(
                                        'name' => 'Sensibilidad',
                                        'description' => 'Habilidad para conectar con la naturaleza y otros seres vivos o capacidad para apreciar la expresión artística',
                                        'icon' => 'sensibilidad',
                                        'position' => array('x' => '3', 'y' => '6')
                                    )
);

function parseBooleanCompetencias($filas) {
    $competencias = array();

    foreach ($filas as $fila) { 
        //var_dump($fila);
        array_push($competencias, boolval($fila));
    }

    return $competencias;
}

function getCompetenciasValues($competencias, $values, $values_dos) {
    $output = '';
    foreach ($competencias as $key => $competencia) {
        $value = 0;
        if ($values[$key] && $values_dos[$key]) {
            $value = 3;
        } else if (!$values[$key] && $values_dos[$key]) {
            $value = 2;
        } else if ($values[$key] && !$values_dos[$key]) {
            $value = 1; 
        }

        $output .= '{';
        $output .= 'name: "' . $competencia['name'] . '",';
        $output .= 'description: "' . $competencia['description'] . '",';
        $output .= 'icon: "' . $competencia['icon'] . '",';
        $output .= 'x: ' . $competencia['position']['x'] . ',';
        $output .= 'y: ' . $competencia['position']['y'] . ',';
        $output .= 'value: ' . $value;
        $output .= '},';
    }
    return $output;
}

$btn_colabora_c_1 = $btn_colabora_c_2 = 0;

if (isset($profesion) && !empty($profesion)) {
    //$filas_competencias = parseBooleanCompetencias($filas_competencias);
    foreach ($filas_competencias as $fila_competencia) { 
        if (is_null($fila_competencia)) {
            $btn_colabora_c_1++;
        }
    }
}

if (isset($profesion_dos) && !empty($profesion_dos)) {
    //$filas_competencias_dos = parseBooleanCompetencias($filas_competencias_dos);
    foreach ($filas_competencias_dos as $fila_competencia_dos) { 
        if (is_null($fila_competencia_dos)) {
            $btn_colabora_c_2++;
        }
    }
}

?>

qsdmRed = 'rgba(214, 46, 70, .75)';
qsdmBlue = 'rgba(51, 122, 183, .75)';
qsdmPurple = 'rgba(145, 51, 183, .75)'
qsdmGrey = 'rgba(187, 187, 187, .85)';

var descriptions = {
    <?php foreach($competencias as $competencia) { 
        echo "'" . $competencia['name'] . "':" . "{";
        echo "'description':" . "'" . $competencia['description'] . "',";
        echo "'icon':" . "'" . $competencia['icon'] . "',";
        echo "},";
    } ?>
};

$('#container_competencias').highcharts({
    chart: {
        type: 'tilemap',
        inverted: true,
        backgroundColor:'rgba(255, 255, 255, 0)',
        // Edit chart size
        spacingBottom: 20,
        spacingTop: 20,
        spacingLeft: 20,
        spacingRight: 20,
        width: null,
        height: 380,
        events: {
            load: function(){
                this.myTooltip = new Highcharts.Tooltip(this, this.options.tooltip);                    
            }
        }
    },
    title: {
        text: 'COMPETENCIAS PROFESIONALES',
        align: "center",
        style: { 
            'color': '#555',
            'fontSize': '14px',
            'fontWeight': 'bold'
        }
    },
    legend: { 
        enable: false,
        itemStyle: {
            width: '300%'
        },
        title: {
            text: '<span>(Click para ver información)</span>',
            style: {
                fontStyle: 'italic',
                fontSize: '9px',
                color: '#888'
            }
        } 
    },
    xAxis: {
        visible: false
    },
    yAxis: {
        visible: false
    },
    colorAxis: {
        dataClasses: [{
            from: 0,
            to: 1,
            color: qsdmGrey,
            name: 'No asignado'
        }, {
            from: 1,
            to: 2,
            color: qsdmRed,
            name: '<?php echo $profesion; ?>'
        }, 
        <?php if (isset($profesion_dos) && !empty($profesion_dos)) { ?>
        {
            from: 2,
            to: 3,
            color: qsdmBlue,
            name: '<?php echo $profesion_dos; ?>'
        }, {
            from: 3,
            color: qsdmPurple,
            name: '<?php echo $profesion . " y " . $profesion_dos; ?>'
        }
        <?php } ?>
        ]
    },
    exporting: {
        buttons: {
            contextButton: {
                menuItems: [{
                    text: '<a><i class="fa fa-facebook-square fa-2x" style="padding:5px"></i>Compartir en Facebook</a>',
                    onclick: function(event) {
                        if (event.target.href === '') {
                            getUrlShare('facebook', this, event.target);    
                        }
                    }
                },{
                    text: '<a><i class="fa fa-linkedin-square fa-2x" style="padding:5px"></i>Compartir en LinkedIn</a>',
                    onclick: function(event) {
                        if (event.target.href === '') {
                        getUrlShare('linkedin', this, event.target);    
                        }
                    }
                },{
                    separator: true
                },{
                    text: '<a href="#"><i class="glyphicon glyphicon-download-alt" style="padding:5px"></i>Descargar JPEG</a>',
                    onclick: function() {
                        this.exportChart({
                            type: 'image/jpeg'
                        });
                    }
                }]
            },
            anotherButton: {
                text: '???',
                y: 28,
                x: 0,
                width: 24,
                onclick: function () {
                    // agregar capa de glosario semitransparente (con opcion a quitar)
                    var capa_glosario = '<div class="capa-glosario">';
                    capa_glosario += '<div class="cerrar-glosario"><img class="icon" src="images/cross.svg"></img></div>';
                    capa_glosario += '<div class="col-md-10 col-md-offset-1">';
                   
                    capa_glosario += '<h3>Dudas? No te preocupes, te lo aclaramos aquí!</h3><br>';
                    capa_glosario += '<dl>';
                    for (name in descriptions) {
                        capa_glosario += '<dt>';
                        capa_glosario += '<img height="20px" width="auto" src="images/iconos/' + descriptions[name].icon + '.png">';
                        capa_glosario += '&nbsp;&nbsp;&nbsp;<strong>' + name + '</strong>';
                        capa_glosario += '</dt>';
                        capa_glosario += '<dd>' + descriptions[name].description + '</dd>';
                    }
                    capa_glosario += '</dl>';

                    capa_glosario += '</div>';
                    capa_glosario += '</div>';

                    $('#container_competencias').append(capa_glosario);

                    // cerrar glosario
                    $('.cerrar-glosario').click( function() {
                        $(this).parent().remove();
                    });
                }
            }
        },
        chartOptions: {
            chart: {
                events: {
                  load: function(event) {                
                    this.renderer.image('https://queserademi.com/images/logo.png', 15, 15, 30, 30).add();
                  }
                } 
            }
        }
    },
    tooltip: {
        shared: true,
        headerFormat: '<strong style="font-size:17px">{point.key}</strong><br>',
        formatter: function() {          
            return '<strong style="font-size:17px;color:rgb(0,0,0);">'+ this.key +'</strong><br/>'+'<span>'+ descriptions[this.key].description +'</span>';   
        },
        style: {
            display: 'block', 
            width: '300px',
            whiteSpace: 'normal'
        }    
    },
    credits: {
         enabled: false
    },
    plotOptions: {
        series: {
            dataLabels: {
                enabled: true,
                color: '#FFFFFF',
                useHTML: true,
                formatter: function() {
                    return '<img class="iconos-competencias" src="images/iconos/' + this.point.icon + '.png">';
                }
            },
            tileShape: 'circle',
            cursor: 'pointer',
            stickyTracking: !isMobile,
            events: {
                mouseOut: function() {
                    this.chart.myTooltip.hide();
                },
                legendItemClick: function() {
                    return !isMobile; 
                }               
            }          
        }
    },
    series: [{
        name: '',
        data: [
            <?php echo getCompetenciasValues($competencias, $filas_competencias[0], $filas_competencias_dos[0]); ?> 
        ]
    }]
});


<?php if( $btn_colabora_c_1 || $btn_colabora_c_2 ) { ?>
    var capa_aviso = '<div class="capa-aviso">';
    capa_aviso += '<div class="cerrar-aviso"><a href="#"><img class="icon" src="images/cross.svg"></img></a></div>';
    capa_aviso += '<div class="col-md-10 col-md-offset-1">';
    capa_aviso += '<h3>Aún no tenemos imformación suficiente!</h3>';

    <?php if( $btn_colabora_c_1 > 0 ) { ?>
        capa_aviso += '<p class="text-center">Ayúdanos a completar información sobre <strong>competencias profesionales</strong> de la profesión<br>';
        capa_aviso += '<strong><?php echo mb_strtoupper($profesion,"UTF-8"); ?></strong></p>';
        capa_aviso += '<a href="https://queserademi.com/colabora.php?profesion=<?php echo $profesion; ?>" class="btn btn-aviso" style="border-color: #d62e46; color: #d62e46;">Colabora!</a>';
    <?php } ?>

    <?php if( $btn_colabora_c_2 > 0 ) { ?>
        capa_aviso += '<p class="text-center">Ayúdanos a completar información sobre <strong>competencias profesionales</strong> de la profesión<br>';
        capa_aviso += '<strong><?php echo mb_strtoupper($profesion_dos,"UTF-8"); ?></strong></p>';
        capa_aviso += '<a href="https://queserademi.com/colabora.php?profesion=<?php echo $profesion_dos; ?>" class="btn btn-aviso" style="border-color: #337ab7; color: #337ab7;">Colabora!</a>';
    <?php } ?>

    capa_aviso += '</div>';
    capa_aviso += '</div>';

    $('#container_competencias').append(capa_aviso);
<?php } ?>